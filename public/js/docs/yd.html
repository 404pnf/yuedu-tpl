<!DOCTYPE html>

<html>
<head>
  <title>yd.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="yd.html">
                yd.coffee
              </a>
            
              
              <a class="source" href="yd_chart.html">
                yd_chart.coffee
              </a>
            
              
              <a class="source" href="yd_conf.html">
                yd_conf.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>yd.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="-">唯一的全局变量</h2>
<p>也是程序的命名空间</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root = <span class="hljs-built_in">global</span> ? <span class="hljs-built_in">window</span>
root.YD <span class="hljs-keyword">or</span>= {}
YD.debug = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="-">工具函数</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>错误就是一个字符串，获取方法是读取 data.error 的值</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">showStatusMsg</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  alertBox data.error
<span class="hljs-function">
<span class="hljs-title">alertBox</span> = <span class="hljs-params">(msg)</span> -&gt;</span>
  $(<span class="hljs-string">"#msg"</span>).text msg
  $(<span class="hljs-string">"#msg"</span>).dialog
    <span class="hljs-attribute">modal</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">buttons</span>:
      <span class="hljs-attribute">Ok</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># do NOT use fat arror!! or the dialog won't close</span>
        $(<span class="hljs-keyword">this</span>).dialog <span class="hljs-string">"close"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>模仿if (predict) {}，</p>
<p>或者说模仿scheme中的when。</p>
<p>注意：action必须是一个返回函数的函数，这样才能延迟执行。
可以用 -&gt; 包裹一下，防止action作为参数时被立即求值。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">doWhen</span> = <span class="hljs-params">(predict, action)</span> -&gt;</span>
  action <span class="hljs-keyword">if</span> predict</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="-">提交表单内容到后台</h2>
<ol>
<li>从表单获取数据</li>
<li>用jquery插件将数据转为json</li>
<li>提交json给后台api</li>
<li>如果后台返回带”error”的键名的对象，显示错误并停止提交，停留在编辑页面</li>
<li>如果后台会返回带有”success”键名的对象，表示提交成功，执行回调函数</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">postJson</span> = <span class="hljs-params">(url, cssID, callback)</span> -&gt;</span>
  formData = <span class="hljs-attribute">data</span>: $(cssID).serializeJSON()

  note formData
<span class="hljs-function">
  <span class="hljs-title">onSuccess</span> = <span class="hljs-params">(data)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> data?. error
      showStatusMsg data
    <span class="hljs-keyword">else</span>
      callback()
<span class="hljs-function">
  <span class="hljs-title">onFailure</span> = <span class="hljs-params">(data, status, xhr)</span> -&gt;</span>
    showStatusMsg <span class="hljs-string">"<span class="hljs-subst">#{data}</span>, <span class="hljs-subst">#{status}</span>, <span class="hljs-subst">#{xhr}</span>"</span>

  $.post url, formData
    .done onSuccess
    .fail onFailure</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>绑定数据到模版并将渲染结果插入到页面</p>
<ol>
<li>SIDE-EFFECT ONLY 做参数使用请包裹在 functin  {} 中</li>
<li>从局部变量获得数据，绑定模版，插入到html页面中。</li>
<li>可以在使用数据前通过callback修饰数据。</li>
<li>callback中修改的是数据的深拷贝。使用underscore-contrib中的snapshot方法
因此不会影响原始数据。</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">renderLocalData</span> = <span class="hljs-params">(data, cssID, tpl, callback)</span> -&gt;</span><span class="hljs-function">
  -&gt;</span>
    cb = callback <span class="hljs-keyword">or</span> _.identity
    clonedData = _.snapshot _.extend(data, YD.conf)
    <span class="hljs-keyword">new</span> EJS(<span class="hljs-attribute">url</span>: YD.conf.tplDir + tpl).update cssID, cb(clonedData)
<span class="hljs-function">
<span class="hljs-title">redirectToUrl</span> = <span class="hljs-params">(url)</span> -&gt;</span>
  <span class="hljs-built_in">window</span>.location.replace url
<span class="hljs-function">
<span class="hljs-title">note</span> = <span class="hljs-params">(msg)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log msg  <span class="hljs-keyword">if</span> YD.debug
<span class="hljs-function">
<span class="hljs-title">hasBlank</span> = <span class="hljs-params">(arr)</span> -&gt;</span>
  isBlank = i<span class="hljs-function"><span class="hljs-title">sBlank</span> = <span class="hljs-params">(e)</span> -&gt;</span>
    e <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>

  coll = _.map(arr, isBlank)

  _.reduce coll, <span class="hljs-function">(<span class="hljs-params">(a, e)</span> -&gt;</span>
    a <span class="hljs-keyword">or</span> e),
    <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="-">用户页面</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>YD.u<span class="hljs-function"><span class="hljs-title">ser</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>后台api的地址再YD.conf中配置</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  userinfo = YD.conf.userInfo
  photos = YD.conf.photos
  grades = YD.conf.grades

  userInfoAndPhoto = $
    .<span class="hljs-keyword">when</span> $.ajax(userinfo), $.ajax(photos)
    .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span>
      _.extend a[<span class="hljs-number">0</span>], b[<span class="hljs-number">0</span>]

  userInfoAll = $
    .<span class="hljs-keyword">when</span> $.ajax(userinfo), $.ajax(grades), $.ajax(photos)
    .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(a, b, c)</span> -&gt;</span>
      _.extend a[<span class="hljs-number">0</span>], b[<span class="hljs-number">0</span>], c[<span class="hljs-number">0</span>]
<span class="hljs-function">
  <span class="hljs-title">userShow</span> = -&gt;</span>
    userInfoAndPhoto.<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      <span class="hljs-keyword">new</span> EJS(<span class="hljs-attribute">url</span>: YD.conf.tplDir + <span class="hljs-string">"user_show.ejs"</span>).update <span class="hljs-string">"user_info"</span>, data
<span class="hljs-function">
  <span class="hljs-title">userBarShow</span> = -&gt;</span>
    userInfoAndPhoto.<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      <span class="hljs-keyword">new</span> EJS(<span class="hljs-attribute">url</span>: YD.conf.tplDir + <span class="hljs-string">"user_bar.ejs"</span>).update <span class="hljs-string">"user_bar"</span>, data
<span class="hljs-function">
  <span class="hljs-title">userEdit</span> = -&gt;</span>
    userInfoAll.<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      <span class="hljs-keyword">new</span> EJS(<span class="hljs-attribute">url</span>: YD.conf.tplDir + <span class="hljs-string">"user_edit.ejs"</span>).update <span class="hljs-string">"user_info"</span>, data
<span class="hljs-function">
  <span class="hljs-title">userPhotoEdit</span> = -&gt;</span>
    userInfoAndPhoto.<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      <span class="hljs-keyword">new</span> EJS <span class="hljs-attribute">url</span>: <span class="hljs-string">"<span class="hljs-subst">#{YD.conf.tplDir}</span>user_photo_edit.ejs"</span>
        .update <span class="hljs-string">"user_info"</span>, data
<span class="hljs-function">
  <span class="hljs-title">userSave</span> = -&gt;</span>
    postJson YD.conf.userSave, <span class="hljs-string">"form#user_info"</span>,<span class="hljs-function"> -&gt;</span>
      redirectToUrl YD.conf.userHomeUrl
<span class="hljs-function">
  <span class="hljs-title">userPhotoSave</span> = -&gt;</span>
    postJson YD.conf.userSave, <span class="hljs-string">"form#user_photo"</span>,<span class="hljs-function"> -&gt;</span>
      redirectToUrl YD.conf.userHomeUrl

  (<span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>直接显示用户信息和头像</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    userShow()
    userBarShow()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>通过jQuery的delegate监听尚未出现在页面的元素</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>编辑用户</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-string">"#user_info"</span>).delegate <span class="hljs-string">"#user_info_edit"</span>, <span class="hljs-string">"click"</span>, userEdit</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>编辑头像</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-string">"#user_info"</span>).delegate <span class="hljs-string">"#user_photo_edit"</span>, <span class="hljs-string">"click"</span>, userPhotoEdit</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>保存用户</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-string">"#user_info"</span>).delegate <span class="hljs-string">"#user_info_save"</span>, <span class="hljs-string">"click"</span>, userSave</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>保存头像</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-string">"#user_info"</span>).delegate <span class="hljs-string">"#user_photo_save"</span>, <span class="hljs-string">"click"</span>, userPhotoSave</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>监听取消编辑用户信息和取消编辑用户头像信息的按钮；</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-string">"#user_info"</span>).delegate <span class="hljs-string">"#user_cancel_edit"</span>, <span class="hljs-string">"click"</span>,<span class="hljs-function"> -&gt;</span>
      redirectToUrl YD.conf.userHomeUrl

  )()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>渲染用户条</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>YD.u<span class="hljs-function"><span class="hljs-title">serBar</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>后台api的地址再YD.conf中配置</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  userinfo = YD.conf.userInfo
  photos = YD.conf.photos

  userInfoAndPhoto = $
    .<span class="hljs-keyword">when</span> $.ajax(userinfo), $.ajax(photos)
    .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span>
      _.extend a[<span class="hljs-number">0</span>], b[<span class="hljs-number">0</span>]

  userInfoAndPhoto.done <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> EJS <span class="hljs-attribute">url</span>: <span class="hljs-string">"<span class="hljs-subst">#{YD.conf.tplDir}</span>user_bar.ejs"</span>
      .update <span class="hljs-string">"user_bar"</span>, data</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="-">用户登录后首页</h2>
<p>每隔一段时间时间查看一下数据源并重新刷新页面。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>YD.s<span class="hljs-function"><span class="hljs-title">tartDispache</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>帮助函数</p>
<ol>
<li>如果考试预告中有考试是今天的就在模版中显示今天两个字</li>
<li>直接修改了examInfo</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">updateDateText</span> = <span class="hljs-params">(d)</span> -&gt;</span>
    o = _.map(d.upcomingExam, <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> e.isTodayExam
        e.endTime = <span class="hljs-string">""</span>
        e.isTodayExam = <span class="hljs-string">"今天"</span>
      <span class="hljs-keyword">else</span>
        e.isTodayExam = <span class="hljs-string">""</span>
      e
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>主函数，可能递归调用</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">next</span> = -&gt;</span>
    getExamInfo = $.get YD.conf.getExamInfo

    promise = getExamInfo
      .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>一次性将数据处理好</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> data.upcomingExam
          _.extend data, updateDateText(data), <span class="hljs-attribute">hasUpcoming</span>: <span class="hljs-literal">true</span>
        <span class="hljs-keyword">else</span>
          _.extend data, <span class="hljs-attribute">hasUpcoming</span>: <span class="hljs-literal">false</span>

    note promise
<span class="hljs-function">
    <span class="hljs-title">onSuccess</span> = <span class="hljs-params">(data)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>将从后台获得的数据（从onSuccess函数的参数传进来）绑定到局部变量</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      examInfo = _.snapshot data</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>将判定抽象为函数</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      hasCurrentExam =  <span class="hljs-string">"currentExam"</span> <span class="hljs-keyword">of</span> examInfo
      hasUpcomingExam = <span class="hljs-string">"upcomingExam"</span> <span class="hljs-keyword">of</span> examInfo
      haslatestExamResult = <span class="hljs-string">"latestExamResult"</span> <span class="hljs-keyword">of</span> examInfo
      userExamState = examInfo?.currentExam?.userExamState</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>有考试，无上次考试成绩 学生状态模版中判定</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ex1up0res0 = hasCurrentExam <span class="hljs-keyword">and</span>
        <span class="hljs-keyword">not</span> haslatestExamResult</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>有考试，有上次考试成绩， 学生状态在模版中判定</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ex1up0res1 = hasCurrentExam <span class="hljs-keyword">and</span>
        haslatestExamResult</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>无考试，有考试预告，无上次考试成绩</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ex0up1res0 = <span class="hljs-keyword">not</span> hasCurrentExam <span class="hljs-keyword">and</span>
        hasUpcomingExam <span class="hljs-keyword">and</span>
        <span class="hljs-keyword">not</span> haslatestExamResult</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>无考试，有考试预告，有上次考试成绩</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ex0up1res1 = <span class="hljs-keyword">not</span> (hasCurrentExam) <span class="hljs-keyword">and</span>
        hasUpcomingExam <span class="hljs-keyword">and</span>
        haslatestExamResult</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>无考试，无考试预告，有上次考试成绩</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ex0up0res1 = <span class="hljs-keyword">not</span> (hasCurrentExam) <span class="hljs-keyword">and</span>
        <span class="hljs-keyword">not</span> hasUpcomingExam <span class="hljs-keyword">and</span>
        haslatestExamResult</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>无考试，无考试预告，无上次成绩
用html的div中默认文字</p>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>partial function to save typing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cssID = <span class="hljs-string">"front_content"</span>
      render = _.partial renderLocalData, examInfo, cssID

      promise.done doWhen ex1up0res0, render <span class="hljs-string">"start_current.ejs"</span>

      promise.done doWhen ex1up0res1, render <span class="hljs-string">"start_scores.ejs"</span>

      promise.done doWhen ex0up1res0, render <span class="hljs-string">"start_upcoming.ejs"</span>

      promise.done doWhen ex0up0res1, render <span class="hljs-string">"start_scores_with_upcoming.ejs"</span>

      promise.done doWhen ex0up1res1, render <span class="hljs-string">"start_scores_with_upcoming.ejs"</span>
<span class="hljs-function">
    <span class="hljs-title">onFailure</span> = -&gt;</span>
      note <span class="hljs-string">"链接后台失败。"</span>

    promise.fail onFailure

    promise.done <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      note data</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>存后台数据到本地</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    promise.done <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      YD.exam = YD.exam <span class="hljs-keyword">or</span> data

    promise.done onSuccess</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>决定是否定时检查后台数据</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    promise.done <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>只有在以下情况都满足时候才不断反复请求后台服务器</p>
<ol>
<li>没有当前考试</li>
<li>有考试预告</li>
<li>考试预告中有今天的考试
这样极大减少了不必要的对后台请求</li>
</ol>
<p>isTodayExam 的值是 true / false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      shouldRetry = <span class="hljs-keyword">not</span> (<span class="hljs-string">"currentExam"</span> <span class="hljs-keyword">of</span> YD.exam) <span class="hljs-keyword">and</span>
        (<span class="hljs-string">"upcomingExam"</span> <span class="hljs-keyword">of</span> YD.exam) <span class="hljs-keyword">and</span>
        _.find YD.exam.upcomingExam, <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span> e.isTodayExam


      <span class="hljs-keyword">if</span> shouldRetry
        note <span class="hljs-string">"满足刷新条件，页面将会刷新。 <span class="hljs-subst">#{<span class="hljs-keyword">new</span> Date()}</span> "</span>
        setTimeout next, <span class="hljs-number">180000</span> <span class="hljs-comment"># 3 mins</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <ol>
<li>马上开始第一次调用</li>
<li>实际上浏览器规范中要求最少4ms</li>
<li>用setTimeout调用另一个setTimeout永远不会出现栈溢出</li>
<li>直接 next 调用会栈溢出的。比如10万次递归后。
参见  effective javascript : tip 64，65, page 155</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setTimeout next, <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="-">登陆页面</h2>
<ol>
<li>校验不能有input字段唯恐</li>
<li>密码用md5求值后再提交给后台</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>YD.u<span class="hljs-function"><span class="hljs-title">serLogin</span> = -&gt;</span>
  $<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">"form"</span>)</span>.<span class="hljs-title">submit</span> <span class="hljs-params">(e)</span> -&gt;</span>
    e.preventDefault()

    name = $(<span class="hljs-string">"#username"</span>).val()
    password = $(<span class="hljs-string">"#password"</span>).val()
    yz = $(<span class="hljs-string">"#yz"</span>).val()</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>是否有input为空</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notValid = hasBlank([
      name
      password
      yz
    ])

    <span class="hljs-keyword">if</span> notValid
      alertBox <span class="hljs-string">"所有输入框都必须填写。"</span>
    <span class="hljs-keyword">else</span>
      $(<span class="hljs-string">"#password"</span>).val $.md5(password)
      postJson YD.conf.userLogin, <span class="hljs-string">"#login"</span>,<span class="hljs-function"> -&gt;</span>
        redirectToUrl YD.conf.siteHomeUrl</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="-">重设密码页面</h2>
<ol>
<li>校验不能有input字段为空</li>
<li>校验两次输入新密码是否匹配</li>
<li>密码用md5求值后再提交给后台</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>YD.r<span class="hljs-function"><span class="hljs-title">esetPass</span> = -&gt;</span>
  $<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">"form"</span>)</span>.<span class="hljs-title">submit</span> <span class="hljs-params">(e)</span> -&gt;</span>
    e.preventDefault()

    oldPass = $(<span class="hljs-string">"#old_pass"</span>).val()
    newPass = $(<span class="hljs-string">"#new_pass"</span>).val()
    newPassConfirm = $(<span class="hljs-string">"#new_pass_confirm"</span>).val()</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>两次输入的新密码是否匹配</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dontMatch = newPass <span class="hljs-keyword">isnt</span> newPassConfirm</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>是否有input为空</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notValid = hasBlank([
      oldPass
      newPass
      newPassConfirm
    ])

    <span class="hljs-keyword">if</span> notValid
      alertBox <span class="hljs-string">"所有输入框都必须填写。"</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> dontMatch
      alertBox <span class="hljs-string">"两次输入的新密码不匹配。"</span>
    <span class="hljs-keyword">else</span>
      $(<span class="hljs-string">"#new_pass"</span>).val $.md5(newPass)
      $(<span class="hljs-string">"#old_pass"</span>).val $.md5(oldPass)
      $(<span class="hljs-string">"#new_pass_confirm"</span>).val $.md5(newPassConfirm)
      postJson YD.conf.userResetPass, <span class="hljs-string">"#reset_pass_form"</span>,<span class="hljs-function"> -&gt;</span>
        redirectToUrl YD.conf.userHomeUrl</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
